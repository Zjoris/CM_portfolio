---
title: "Computational Musicology Portfolio"
author: "Joris Galema"
output: 
  flexdashboard::flex_dashboard:
    theme: journal
    
#runtime: shiny
---

<style>
    .navbar {
      margin: 0;
      padding: 0;
      height: 100%;
      display: block;
      position: fixed;
      width: 200px; /* Modify the width of the sidebar */
    }
    body {
      margin-left: 200px; /* Add a left margin to avoid content overlay */
      padding-top:0px
    }
    </style>


Overview
=============================
### Analysing daily mixes and discover weekly playlists


As an active Spotify user I often contemplate about maintaining an enormous playlist of songs that I like. However, in my opinion, if you really like a song you'll remember it, so there is no need for a playlist to remind you of what songs you like.
That being said, I do need some type of playlist to get my day started. Therefore I listen to my daily mixes almost exclusively. Occasionally I listen to my discover weekly playlist that always surprises me with its quality of recommended songs. Somehow these playlists seem fresh every time while at the same time containing a lot of songs that I know and love. 

This made me wonder how these playlists vary from day to day and week to week and how my discover weekly relates to my daily mixes.

Therefore I will be analyzing my daily mixes and discover weekly playlists for the duration of 7 weeks. The interest lies mostly on the relation between the daily mixes and the discover weekly playlist.
There is two things I hope to discover:

(1) Is there a way to predict my discover weekly playlist of the next week based on my daily mixes of the current week.

(2) Is there a way to predict which daily mixes I listened to in the previous week(s) based on my discover weekly playlist. 

My daily mixes usually range from playlists containing Pixies and the Velvet Underground to playlists containing Miles Davis and Charlie Parker to playlists containing Eagles of death metal and the Black keys to playlists containing Canned heat and Roy Buchannan. Sometimes my daily mixes vary a lot with regard to each other, causing my discover weekly playlist to be a total mess sometimes. This will be very interesting to analyze.

spotify user id of me: `r Sys.getenv("SPOTIFY_MY_ID")`.

Below You can see a table of all the tracks that occur in my corpus. ordered in descending frequency of occurence. 

```{r include=FALSE}
library(dbplyr)
library(tidyverse)
library(spotifyr)
library(ggplot2)
library(compmus)
library(plotly)
library(Cairo)
library(purrr)
library(ggpubr)
library(tidymodels)
library(ggdendro)
library(heatmaply)
library(knitr)
library(nnls)
library(kableExtra)
library(DT)

get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit %>% 
    collect_predictions() %>% 
    conf_mat(truth = outcome, estimate = .pred_class)
}  

get_pr <- function(fit) {
  fit %>% 
    conf_mat_resampled() %>% 
    group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>% 
    group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>% 
    ungroup() %>% filter(Prediction == Truth) %>% 
    select(class = Prediction, precision, recall)
}  
```




```{r eval=FALSE, include=FALSE}
playlists <- tibble()
for (i in c(0,50,100,150,200,250)) {
  playlists <- bind_rows(
    playlists, get_user_playlists("kmkov4v2xhms7od6p3gq32wfv",limit=50,offset = i)
  )
}
tracks <- tibble()
for (pl in unlist(playlists["id"])) {
  tracks <- bind_rows(
    tracks, get_playlist_audio_features("",pl)
  )
}
```

```{r eval=FALSE, include=FALSE}
get_week_n <- function(day) {
  day[is.na(day)] <- "14/02"
  d = as.integer(substr(day,0,2))
  m = as.integer(substr(day,4,6))
  if(m==2) {
    nmbr = case_when(
      d < 8 ~ 1,
      d %in% 8:14 ~ 2,
      d %in% 15:21 ~ 3,
      d %in% 22:28 ~ 4
    )
  }
  if(m==3) {
    nmbr = case_when(
      d %in% 1:7 ~ 5,
      d %in% 8:14 ~ 6,
      d %in% 15:21 ~ 7
    )
  }
  return(as.integer(nmbr))
}

tracks <- tracks %>%
  mutate(
    type = ifelse(substr(playlist_name,0,1) == 'W' ,"Discover Weekly","Daily Mix"),
    Day = ifelse(type=="Daily Mix",substr(playlist_name,3,7),NA),
    Weeknmbr = ifelse(type=="Daily Mix",map_chr(Day,get_week_n),substr(playlist_name,7,7))
  ) 
```


```{r}

extract_name <- function(artist) {
  return(paste(artist$name,collapse = ", "))
}

tracks %>% 
  count(track.name,track.artists,track.album.name) %>% 
  arrange(desc(n)) %>% 
  mutate(track.artists = track.artists %>% map_chr(extract_name)) %>% 
  select(track.name,track.artists,n) %>% 
  datatable(extensions = "Buttons", options = list(dom="Blfrtip",buttons = c('copy','csv','print'),lengthMenu = list(c(10,25,50,-1),c(10,25,50,"All"))))
```

<!-- Songs that are most are not my favourites. Maybe spotify biased because of popularity or something of music. Or I am biased because I don't like the music that I see the most the most. -->



Analysis of the weekly playlists {.storyboard}
===========================================


```{r include=FALSE}


W <- tracks %>% 
  filter(type == "Discover Weekly")

```


### Valence, energy, major/minor and tempo

```{r echo=FALSE}
W %>%
  mutate(
    mode = ifelse(mode == 0, "Minor", "Major")
  ) %>%
  ggplot(aes(x = valence, y = energy,color = tempo,shape=mode)) + geom_point(alpha=0.5,size=4) +facet_wrap(~Weeknmbr)
```

***

In terms of energy/valence the two discover weeklies are distributed fairly similar.
However Weekly 1 is more scattered whereas weekly 2 can be divided into two groups (seen in next plot). Loudness is pretty much the same among all songs. 
Both playlists consist of mostly major songs which, honestly, was to my surprise. 
Something interesting in weekly 2 is that the songs with highest valence and highest energy are songs in a minor key.


### Change of energy in songs in the discover weekly playlists
```{r echo=FALSE}
W %>%
  ggplot(aes(x = Weeknmbr,y=energy)) + geom_violin()
```


### Keys 
```{r echo=FALSE}
int2key <- function(i) {
  out = case_when(
    i == 0 ~ "C",
    i == 1 ~ "C#",
    i == 2 ~ "D",
    i == 3 ~ "D#",
    i == 4 ~ "E",
    i == 5 ~ "F",
    i == 6 ~ "F#",
    i == 7 ~ "G",
    i == 8 ~ "G#",
    i == 9 ~ "A",
    i == 10 ~ "A#",
    i == 11 ~ "B"
  )
  return(out)
}
  
W %>%
  mutate(key = int2key(key)) %>% 
  ggplot(aes(key_mode)) +geom_bar(fill="light green",color="white",alpha=0.8) + facet_wrap(~Weeknmbr) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

***

Weekly 1 seems to be mostly in "A". This makes sense because the songs in that playlist have a lot more simplicity to them. And A is a pretty "go to" key in my opinion.


### Tempo

```{r}
W %>% 
  ggplot(aes(tempo)) +geom_histogram(fill="red",color="white",alpha=0.8,bins=15) + facet_wrap(~Weeknmbr)
```

### Loudness

```{r}
W %>% 
  ggplot(aes(loudness)) +geom_histogram(fill="blue",color="white",alpha=0.8,bins=15) + facet_wrap(~Weeknmbr)
```




Daily v Weekly
================================================================

Column{.tabset .data-width = 600}
-------------------------------------------------------

```{r eval=FALSE, include=FALSE}
#print(unlist(playlists["id"]))

ValEnMeans <- tracks %>% 
  filter(Weeknmbr==1) %>% 
  group_by(playlist_name) %>% 
  summarise(
    valence = mean(valence),
    energy = mean(energy),
    track.name = "Mean Valence,Energy"
  )

ValEner1 <- tracks %>%
  filter(Weeknmbr==1) %>% 
  #group_by(Day) %>% 
  ggplot(aes(x = valence, y = energy,color = playlist_name,text=track.name)) + geom_point(alpha=0.3) + geom_point(data=ValEnMeans,size=3,alpha=15,shape=3)

W1 <- tracks %>% filter(playlist_name=="Weekly1")


ValEner1 <- ggplotly(ValEner1)
ValEner1 <- ValEner1 %>% layout(
  title = "Week 1 Discover Weekly vs Dailies",
  updatemenus = list(
    list(
      y = 0.9,
        buttons = list(
          list(method = "restyle",
               args = list("visible", list(TRUE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE)),
               label = "04/02"),

          list(method = "restyle",
               args = list("visible", list(FALSE,TRUE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,FALSE,FALSE,TRUE,FALSE,TRUE)),
               label = "05/02"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE, TRUE, FALSE, FALSE, TRUE, FALSE, FALSE, TRUE, FALSE, FALSE, TRUE, FALSE, FALSE,TRUE, FALSE, FALSE,TRUE, TRUE)),
               label = "07/02")
          
          )))
    )

#ValEner1 <- ValEner1 %>% add_trace(type="scatter",x=W1$valence,y=W1$energy)

ValEnMeans2 <- tracks %>% 
  filter(Weeknmbr==2) %>% 
  group_by(playlist_name) %>% 
  summarise(
    valence = mean(valence),
    energy = mean(energy),
    track.name = "Mean Valence,Energy"
  )

ValEner2 <- tracks %>%
  filter(Weeknmbr==2) %>% 
  #group_by(Day) %>% 
  ggplot(aes(x = valence, y = energy,color = playlist_name,text=track.name)) + geom_point(alpha=0.3) + geom_point(data=ValEnMeans2,size=3,alpha=15,shape=3)

W1 <- tracks %>% filter(playlist_name=="Weekly2")


ValEner2 <- ggplotly(ValEner2) %>% layout(
  title = "Week 2 Discover Weekly vs Dailies",
  updatemenus = list(
    list(
      y = 0.9,
        buttons = list(
          list(method = "restyle",
               args = list("visible", list(TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE)),
               label = "08/02"),

          list(method = "restyle",
               args = list("visible", list(FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE, TRUE)),
               label = "09/02"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE, TRUE,FALSE,FALSE, FALSE, FALSE, TRUE,FALSE,FALSE, FALSE, FALSE, TRUE,FALSE,FALSE, FALSE, FALSE, TRUE,FALSE,FALSE, FALSE, FALSE,TRUE, FALSE, FALSE,FALSE,FALSE,TRUE,FALSE,FALSE, TRUE)),
               label = "11/02"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE, TRUE,FALSE, FALSE, FALSE,FALSE, TRUE,FALSE,FALSE, FALSE,FALSE, TRUE,FALSE,FALSE, FALSE,FALSE, TRUE,FALSE,FALSE, FALSE,FALSE, TRUE,FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, TRUE)),
               label = "12/02"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, FALSE,TRUE, FALSE, FALSE, FALSE, FALSE,TRUE, FALSE, FALSE, FALSE, FALSE,TRUE, FALSE, FALSE,FALSE, FALSE,TRUE, FALSE, FALSE,FALSE, FALSE,TRUE, TRUE)),
               label = "14/02")
          
          )))
    )

ValEnMeans3 <- tracks %>% 
  filter(Weeknmbr==3) %>% 
  group_by(playlist_name) %>% 
  summarise(
    valence = mean(valence),
    energy = mean(energy),
    track.name = "Mean Valence,Energy"
  )

ValEner3 <- tracks %>%
  filter(Weeknmbr==3) %>% 
  #group_by(Day) %>% 
  ggplot(aes(x = valence, y = energy,color = playlist_name,text=track.name)) + geom_point(alpha=0.3) + geom_point(data=ValEnMeans3,size=3,alpha=15,shape=3)

W1 <- tracks %>% filter(playlist_name=="Weekly3")


ValEner3 <- ggplotly(ValEner3) %>% layout(
  title = "Week 3 Discover Weekly vs Dailies",
  updatemenus = list(
    list(
      y = 0.9,
       buttons = list(
          list(method = "restyle",
               args = list("visible", list(TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE)),
               label = "15/02"),

          list(method = "restyle",
               args = list("visible", list(FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE, TRUE)),
               label = "17/02"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE, TRUE,FALSE,FALSE,FALSE, FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE, TRUE)),
               label = "18/02"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE, TRUE,FALSE, FALSE, FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE, TRUE)),
               label = "19/02"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE, FALSE, TRUE, FALSE, FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE, TRUE)),
               label = "20/02"),
          
           list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE, TRUE)),
               label = "21/02")
          
          
          )))
    )

ValEnMeans4 <- tracks %>% 
  filter(Weeknmbr==4) %>% 
  group_by(playlist_name) %>% 
  summarise(
    valence = mean(valence),
    energy = mean(energy),
    track.name = "Mean Valence,Energy"
  )

ValEner4 <- tracks %>%
  filter(Weeknmbr==4) %>% 
  #group_by(Day) %>% 
  ggplot(aes(x = valence, y = energy,color = playlist_name,text=track.name)) + geom_point(alpha=0.3) + geom_point(data=ValEnMeans4,size=3,alpha=15,shape=3)

W1 <- tracks %>% filter(playlist_name=="Weekly4")


ValEner4 <- ggplotly(ValEner4) %>% layout(
  title = "Week 4 Discover Weekly vs Dailies",
  updatemenus = list(
    list(
      y = 0.9,
       buttons = list(
          list(method = "restyle",
               args = list("visible", list(TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE)),
               label = "22/02"),

          list(method = "restyle",
               args = list("visible", list(FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE, TRUE)),
               label = "23/02"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE, TRUE,FALSE,FALSE,FALSE, FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE, TRUE)),
               label = "24/02"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE, TRUE,FALSE, FALSE, FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE, TRUE)),
               label = "25/02"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE, FALSE, TRUE, FALSE, FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE, TRUE)),
               label = "27/02"),
          
           list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE, TRUE)),
               label = "28/02")
          
          
          )))
    )

ValEnMeans5 <- tracks %>% 
  filter(Weeknmbr==5) %>% 
  group_by(playlist_name) %>% 
  summarise(
    valence = mean(valence),
    energy = mean(energy),
    track.name = "Mean Valence,Energy"
  )


ValEner5 <- tracks %>%
  filter(Weeknmbr==5) %>% 
  #group_by(Day) %>% 
  ggplot(aes(x = valence, y = energy,color = playlist_name,text=track.name)) + geom_point(alpha=0.3) + geom_point(data=ValEnMeans5,size=3,alpha=15,shape=3)

W1 <- tracks %>% filter(playlist_name=="Weekly5")


ValEner5 <- ggplotly(ValEner5)
ValEner5 <- ValEner5 %>% layout(
  title = "Week 1 Discover Weekly vs Dailies",
  updatemenus = list(
    list(
      y = 0.9,
        buttons = list(
          list(method = "restyle",
               args = list("visible", list(TRUE,FALSE,FALSE,F,TRUE,FALSE,FALSE,F,TRUE,FALSE,FALSE,F,TRUE,FALSE,FALSE,F,TRUE,FALSE,FALSE,F,TRUE,FALSE,FALSE,F,TRUE)),
               label = "01/03"),

          list(method = "restyle",
               args = list("visible", list(FALSE,TRUE,FALSE,F,FALSE,TRUE,FALSE,F,FALSE,TRUE,FALSE,F,FALSE,TRUE,FALSE,F,FALSE,TRUE,FALSE,F,FALSE,TRUE,FALSE,F,TRUE)),
               label = "02/03"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE, TRUE,F, FALSE, FALSE, TRUE,F, FALSE, FALSE, TRUE,F, FALSE, FALSE, TRUE,F, FALSE, FALSE,TRUE,F, FALSE, FALSE,TRUE,F, TRUE)),
               label = "05/03"),
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE, F,TRUE, FALSE, FALSE,F,T, FALSE, FALSE,F, TRUE, FALSE, FALSE, F,TRUE, FALSE, FALSE,F,TRUE, FALSE, FALSE,F,T, TRUE)),
               label = "07/03")
          
          )))
    )

ValEnMeans6 <- tracks %>% 
  filter(Weeknmbr==6) %>% 
  group_by(playlist_name) %>% 
  summarise(
    valence = mean(valence),
    energy = mean(energy),
    track.name = "Mean Valence,Energy"
  )

ValEner6 <- tracks %>%
  filter(Weeknmbr==6) %>% 
  #group_by(Day) %>% 
  ggplot(aes(x = valence, y = energy,color = playlist_name,text=track.name)) + geom_point(alpha=0.3) + geom_point(data=ValEnMeans6,size=3,alpha=15,shape=3)

W1 <- tracks %>% filter(playlist_name=="Weekly6")

ValEner6 <- ggplotly(ValEner6) %>% layout(
  title = "Week 6 Discover Weekly vs Dailies",
  updatemenus = list(
    list(
      y = 0.9,
       buttons = list(
          list(method = "restyle",
               args = list("visible", list(TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,F,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,F,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,F,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,F,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,F,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,F,TRUE)),
               label = "08/03"),

          list(method = "restyle",
               args = list("visible", list(FALSE,TRUE,F,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,F,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,F,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,F,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,F,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,F,FALSE,FALSE,FALSE,FALSE, TRUE)),
               label = "09/03"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE, TRUE,F,FALSE,FALSE,FALSE, FALSE, FALSE, TRUE,F,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,F,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,F,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,F,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,F,FALSE,FALSE,FALSE, TRUE)),
               label = "10/03"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE, TRUE,F,FALSE, FALSE, FALSE, FALSE,FALSE, TRUE,F,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,F,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,F,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,F,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,F,FALSE, FALSE, TRUE)),
               label = "11/03"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE, FALSE, TRUE,F, FALSE, FALSE, FALSE,FALSE, FALSE, TRUE,F, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE,F, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE,F, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE,F, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE,F, FALSE, TRUE)),
               label = "12/03"),
          
           list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,F,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,F,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,F,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,F,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,F,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,F, TRUE)),
               label = "13/03"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE,FALSE, FALSE,F, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE,F, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE,F, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE,F, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, F,TRUE,FALSE, FALSE,FALSE,FALSE, FALSE,F, TRUE, TRUE)),
               label = "14/03")
          
          
          )))
    )

ValEnMeans7 <- tracks %>% 
  filter(Weeknmbr==7) %>% 
  group_by(playlist_name) %>% 
  summarise(
    valence = mean(valence),
    energy = mean(energy),
    track.name = "Mean Valence,Energy"
  )

ValEner7 <- tracks %>%
  filter(Weeknmbr==7) %>% 
  #group_by(Day) %>% 
  ggplot(aes(x = valence, y = energy,color = playlist_name,text=track.name)) + geom_point(alpha=0.3) + geom_point(data=ValEnMeans7,size=3,alpha=15,shape=3)

W1 <- tracks %>% filter(playlist_name=="Weekly7")


ValEner7 <- ggplotly(ValEner7) %>% layout(
  title = "Week 7 Discover Weekly vs Dailies",
  updatemenus = list(
    list(
      y = 0.9,
       buttons = list(
          list(method = "restyle",
               args = list("visible", list(TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE)),
               label = "15/03"),

          list(method = "restyle",
               args = list("visible", list(FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE,FALSE,FALSE,FALSE,FALSE, TRUE)),
               label = "16/03"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE, TRUE,FALSE,FALSE,FALSE, FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE,FALSE, FALSE, TRUE,FALSE,FALSE,FALSE, TRUE)),
               label = "17/03"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE, TRUE,FALSE, FALSE, FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE,FALSE, FALSE,FALSE, TRUE,FALSE, FALSE, TRUE)),
               label = "18/03"),
          
          list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE, FALSE, TRUE, FALSE, FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE,FALSE, FALSE,FALSE, FALSE, TRUE, FALSE, TRUE)),
               label = "19/03"),
          
           list(method = "restyle",
               args = list("visible", list(FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE,FALSE, FALSE,FALSE,FALSE, FALSE, TRUE, TRUE)),
               label = "21/03")
          
          
          )))
    )
```

### Valence and Energy 1 ###

```{r}
# ValEner1%>% htmlwidgets::onRender("
# function(el, x) {
# // when hovering over an element, do something
# el.on('plotly_hover', function(d) {
# image_location = https://i.scdn.co/image/ab67616d0000b273b6fccabcb9dbfa78a0026482;
# // define image to be shown
# var img = {
# // location of image
# source: image_location,
# // top-left corner
# x: 1,
# y: 0,
# sizex: 0.2,
# sizey: 0.2,
# xref: 'paper',
# yref: 'paper'
# };
# // show image and annotation
# Plotly.relayout(el.id, {
# images: [img]
# });
# })
# }
# ")

ValEner1
```


### Valence and Energy 2 ###

```{r}
ValEner2
```


### Valence and Energy 3 ###

```{r}
ValEner3
```


### Valence and Energy 4 ###

```{r}
ValEner4
```

### Valence and Energy 5

```{r}
ValEner5
```


### Valence and Energy 6

```{r}
ValEner6
```


### Valence and Energy 7

```{r}
ValEner7
```


Column {data-width = 200}
----------------------------------------------------------
### Some Explanation
Weeks 1-3 energy valence mean of DW playlists in the middle of means for daily mixes.
Week 4 DW playlist mean outside of the daily mixes 


Chroma Features{.storyboard}
=====================================================================
### Chromagraphs for two versions of Paranoid android


#### Radiohead

```{r eval=FALSE, include=FALSE}
song <-
  get_tidy_audio_analysis("6LgJvl0Xdtc73RJ1mmpotq") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

song2 <-
  get_tidy_audio_analysis("2sowiwuhxt4nLIWP6vWJOa") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)
  

chromagram <- song %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  ggtitle("Paranoid Android by Radiohead") +
  theme_minimal() +
  scale_fill_viridis_c()

```

```{r}
chromagram
```


****

Same song. Drastically differently performed. You can see that both versions have a similar structure regarding the chord changes but the changes are at different moments. Also Brad Mehldau really emphasizes one chord whereas the Radiohead version has the chroma magnitude more spread out at each time. A reason for this is probably that the Brad Mehldau version is mostly piano.
Also note that the original (Radiohead) version ends the song mostly in A with some magnitude in D E and F as well. Brad Mehldau takes this and turns it around, putting a lot of the energy in D E and F and less in A. 

#### Brad Mehldau

```{r eval=FALSE, include=FALSE}

chromagram2 <- song2 %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  ggtitle("Paranoid Android by Brad Mehldau") +
  theme_minimal() +
  scale_fill_viridis_c()

```

```{r}
chromagram2
```



### Trying to find a dynamic warp path for these two versions is quite hard
```{r eval=FALSE, include=FALSE}

dtw <- compmus_long_distance(
  song %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  song2 %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  feature = pitches,
  method = "aitchison"
) %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Radiohead", y = "Brad Mehldau") +
  ggtitle("Paranoid Android DTW") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)

```


```{r}
dtw

```

*** 

Due to the completely different timings in the song and generally different approach to the song, they are completely different songs according to Dynamic Time Warping. Let's take a look at another example.

### "Hey Joe", both covers, one very popular, one less popular (but really should be)

```{r eval=FALSE, include=FALSE}
Jimi <- get_tidy_audio_analysis("0NWPxcsf5vdjdiFUI8NgkP") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)
  
Roy <- get_tidy_audio_analysis("44uQ9n6xSO7vMA7z8Cciwo") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

```


#### Roy Buchannan 

```{r eval=FALSE, include=FALSE}
chromagram3 <- Roy %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  ggtitle("Hey Joe(live Austin Texas) by Roy Buchannan") +
  theme_minimal() +
  scale_fill_viridis_c()
```

```{r}
chromagram3
```


**** 

Both have a heavy concentration in E. But are very different for the rest. 

#### Jimi Hendrix

```{r}
chromagram4 <- Jimi %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  ggtitle("Hey Joe by Jimi Hendrix") +
  theme_minimal() +
  scale_fill_viridis_c()
```

```{r}
chromagram4
```


### DTW path is even less observable now

```{r eval=FALSE, include=FALSE}
dtw2 <- compmus_long_distance(
  Roy %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  Jimi %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  feature = pitches,
  method = "aitchison"
) %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Roy", y = "Jimi") +
  ggtitle("Hey Joe") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)
```

```{r}
dtw2
```


***

Even though when you listen to both songs you can immediately link them (probably due to the lyrics), they are nothing alike due to DTW.

Still, when I listen to these two covers I feel that they are more similar than the two "Paranoid Android" versions which does contain some clearer warping paths (upper right area)

(Side note if you don't know the Roy Buchanan version and you like the Jimi Hendrix version really give Roy's version a listen)


### Twelve bar blues 

```{r eval=FALSE, include=FALSE}
Cantquit <- get_tidy_audio_analysis("62QInSlXQI11BR9ycVWjd6") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)
  
Thrill <- get_tidy_audio_analysis("4NQfrmGs9iQXVQI9IpRhjM") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

Crossroads <- get_tidy_audio_analysis("6PUabSMXmPnZna361Wwmf7") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)
```

#### Crossroads by Cream

```{r eval=FALSE, include=FALSE}
chromagram5 <- Crossroads %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  ggtitle("the Crossroads by Cream") +
  theme_minimal() +
  scale_fill_viridis_c()
```

```{r}
chromagram5
```


#### I can't quit you baby by Led Zeppelin

```{r eval=FALSE, include=FALSE}
chromagram6 <- Cantquit %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  ggtitle("I Cant Quit You Baby by Led Zeppelin ") +
  theme_minimal() +
  scale_fill_viridis_c()
```

```{r}
chromagram6
```


### DTW

```{r eval=FALSE, include=FALSE}
dtw3 <- compmus_long_distance(
  Crossroads %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  Cantquit %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  feature = pitches,
  method = "aitchison"
) %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Crossroads", y = "I Can't quit you baby") +
  ggtitle("Twelve Bar Blues") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)
```

```{r}
dtw3
```


*** 

I'm pretty sure there is a example that shows two 12 bar blues tracks with a really visible dtw line. But I haven't found the example yet. 


### Concluding thoughts

Covers don't have to sound like eachother. (Will expand in the future)

I Am pretty sure I will be removing this because I do not think this will be interesting for my portfolio. However analysis of chroma might be useful for similarity measures (Turning every DTW into a number by summing all the distances or something to see how similar two songs are chroma wise (very costly though)). 


<!-- Check daily mix A (25/02). It contains Roy Buchannan, fugazi, steppenwolf and black sabbath (it's a mess).  -->

Chroma and Timbre analyses for two completely different songs{.storyboard}
=====================================


### Miss Alissa by Eagles of Death metal and Heather by Billy Cobham

So I took a look in terms of valence and energy for two songs that should be polar opposites according to valence and energy and boy is that right. 

In the lower left corner we have, with a valence of 0.041, an energy rating of 0.0079 and a length of 8 minutes and 39 seconds, the smooth and shockingly calming "Heather" by Billy Cobham. 

In the opposing upper right corner we have, with a valence of 0.877, energy rating of 0.992 and a length of 2 minutes and 38 seconds, you can't stop dancing to this one, "Miss Alissa" by Eagles of Death Metal. 

I analysed differences in chromagrams, cepstograms and self similarity matrices. 


```{r eval=FALSE, include=FALSE}
msAlis <-
  get_tidy_audio_analysis("1YIxmHt4EKS0gMs3L0mxQV") %>% # Change URI.
  compmus_align(bars, segments) %>%                     # Change `bars`
  select(bars) %>%                                      #   in all three
  unnest(bars) %>%                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )

Heather <-
  get_tidy_audio_analysis("4mraRJO2iZA5WQ5dxlSQx9") %>% # Change URI.
  compmus_align(bars, segments) %>%                     # Change `bars`
  select(bars) %>%                                      #   in all three
  unnest(bars) %>%                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )
```


```{r eval=FALSE, include=FALSE}
 AT <- msAlis%>%
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  scale_fill_viridis_c() +                              
  theme_classic()

 HT <- Heather %>%
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  scale_fill_viridis_c() +                              
  theme_classic()
 
AP <- msAlis %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

HP <- Heather %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```

```{r eval=FALSE, include=FALSE}
ASSt <- msAlis %>%
  compmus_self_similarity(timbre, "cosine") %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")

HSSt <- Heather %>%
  compmus_self_similarity(timbre, "cosine") %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d,
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "") #+ xlim(200,350) + ylim(200,350)

ASSp <- msAlis %>%
  compmus_self_similarity(pitches, "cosine") %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d,
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "") 

HSSp <- Heather %>%
  compmus_self_similarity(pitches, "cosine") %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d,
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "") 
```


```{r eval=FALSE, include=FALSE}
Pplot <- ggarrange(AP, HP, 
          labels = c("Miss Alissa", "Heather"),
          ncol = 1, nrow = 2,vjust = -0.5) %>% 
  annotate_figure(
    top = text_grob("Chromagrams")
  )

Tplot <- ggarrange(AT, HT, 
          labels = c("Miss Alissa", "Heather"),
          ncol = 1, nrow = 2,vjust=-0.5)%>% 
  annotate_figure(
    top = text_grob("Cepstograms")
  )

SStplot <- ggarrange(ASSt, HSSt, 
          labels = c("Miss Alissa", "Heather"),
          ncol = 2, nrow = 1)%>% 
  annotate_figure(
    top = text_grob("Self similarity matrices (timbre)")
  )

SSpplot <- ggarrange(ASSp, HSSp, 
          labels = c("Miss Alissa", "Heather"),
          ncol = 2, nrow = 1)%>% 
  annotate_figure(
    top = text_grob("Self similarity matrices (pitch)")
  )
```

### Chroma comparisson

```{r}
Pplot
```

*** 

Miss Alissa seems to be all over the place in terms of chroma, whilst Heather is more organized and stays close to F for the whole duration of the song. Of course Heather is a lot longer so it leaves a lot more room for organization and build up.

### MFCC comparisson

```{r}
Tplot
```

*** 

Miss Alissa seems to mostly concentrated in the first cepstral coefficients whilst Heather is concentrated more in the second and third. 

First cepstral coefficient referring to loudness seems appropriate because Miss Alissa is quite loud and Heather is quite quiet. 

Around 220 seconds the saxophone joins the song Heather which is observable in the cepstogram due to the distribution of magnitude getting more spread out. 


### Self similarity matrices Timbre

```{r}
SStplot
```

***

The self similarity matrices in terms of timbre show that Miss Alissa is fairly constant in terms of timbre whilst Heather shows a big change around 220 seconds which is because of the saxophone taking the lead. 


### Self Similarity matrices Pitch

```{r}
SSpplot
```

*** 

Now it's funny to see that the chromagram of Miss Alissa is complete chaos but the self similarity matrix is fairly constant and looks like one block implying that it might be quite chaotic but the chaos is very constant, which is actually a pretty good dexcription for the song. 

On the other hand there is Heather that has a very organized chromagram that looks fairly constant but the self similarity matrix in terms of pitches looks a lot more complex than that of Miss Alissa. 



Key Estimation
===========================

Column
----------------------------------------------------------

```{r eval=FALSE, include=FALSE}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <- c(5.0, 2.0, 3.5, 2.0, 4.5, 4.0, 2.0, 4.5, 2.0, 3.5, 1.5, 4.0) 
minor_key <- c(5.0, 2.0, 3.5, 4.5, 2.0, 4.0, 2.0, 4.5, 3.5, 2.0, 1.5, 4.0) 

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )
```

### Giant Steps Keydograph ###
```{r}
gStep <- twenty_five <-
  get_tidy_audio_analysis("18KSLe1ScEmgFt1XnyRSCV") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"
      )
  )

gStep %>% compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "angular",  # Try different distance metrics
    norm = "euclidean"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "") + 
  ggtitle("Giant Steps by John Coltrane")
```

Column
----------------------------------------------------------

### Giant Steps ###


Giant steps is notorious for its intricate key changes, changing key 10 times throughout the song and changing between B, Eb and G, all major thirds apart. 

In the keydograph (?) you can see that it is hard to tell what key the song is in.

The most apparent key in the keydograph is Cmaj which is a semitone above the key the song starts in. Why exactly this is I do not know. 

It is possible that due to the melody, that often wanders away from the notes of the current key, different notes get emphasized causing the assumption of a different key. Combining this with the many key changes, this might be why the keys are all over the place.

Conclusion: Sorry mr. Coltrane, I can't find your keys here. 





Clustering comparisson to daily mixes {.storyboard}
===============================================

```{r eval=FALSE, include=FALSE}
tracks0702 <- tracks %>% 
  filter(Day == "07/02") %>% 
  add_audio_analysis() %>%
  mutate(
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))
```

```{r eval=FALSE, include=FALSE}
tracks_cluster <- recipe(
    track.id ~
      energy +
      key +
      loudness +
      mode +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      time_signature +
      track.duration_ms+
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
      #track.album.release_date,
    data = tracks0702 %>% mutate(track.album.release_date = as.numeric(substr(track.album.release_date,1,4)) )
  ) %>%
  step_center(all_predictors()) %>%
  #step_scale(all_predictors()) %>% 
  step_range(all_predictors()) %>% 
  prep(tracks0702 ) %>%
  juice() %>% 
  column_to_rownames("track.id")

#%>% mutate(track.name = str_trunc(track.name, 20))
```

```{r eval=FALSE, include=FALSE}
cluster0702 <- kmeans(tracks_cluster,6)

```



```{r eval=FALSE, include=FALSE}

get_clust <- function(id) {
  return(cluster0702$cluster[id])
}

tracks0702cl <- tracks0702 %>% mutate(cluster = map_chr(track.id,get_clust))

VE0702pl <- tracks0702 %>% 
  ggplot(aes(valence,energy,color=playlist_name)) + geom_point()

VE0702cl <- tracks0702cl %>% 
  ggplot(aes(valence,energy,color=cluster)) + geom_point()
  
  
```

### Clustering ###

```{r eval=FALSE, include=FALSE}
clusterplotVE <- ggarrange(ggplotly(VE0702pl) , ggplotly(VE0702cl) , 
          labels = c("Daily_mixes", "K-means Clusters"),
          ncol = 2, nrow = 1)%>% 
  annotate_figure(
    top = text_grob("Daily mixes and Kmeans clusters")
  )

clusterplotVE <- subplot(ggplotly(VE0702pl), ggplotly(VE0702cl), nrows = 2, margin = 0.04, heights = c(0.5, 0.5))
```

```{r}
clusterplotVE
```

***

I thought it might be fun to see if I could cluster a day of songs into 6 clusters which resemble daily mixes. For this reason hierarchical clustering did not seem like the best option for it will be hard to pick 6 clusters with hierarchical clustering because it always branches out in 2. Meaning that I'd have to pick a depth with either 4 clusters or 8 clusters. 

Therefore I have used k-means with k=6 to find 6 clusters. 

I used energy, key, loudness, mode, speechiness, acousticness, instrumentalness, liveness, valence, tempo, time_signature, track.duration_ms and the MFCC's as features for clustering.

Here you can see a graph of the energy and valence of the daily mixes (top) and the clusters (bottom). It is fairly apparent that valence and energy do not have a lot of say in distinguishing both daily mixes and k-means clusters. 

Let's find the important features.

***


### Training a classifier to determine cluster important features ###

```{r eval=FALSE, include=FALSE}
tracks_rec <-
  recipe(
    cluster ~
      energy +
      key +
      loudness +
      mode +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      time_signature +
      track.duration_ms+
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = tracks0702cl,          # Use the same name as the previous block.
  ) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors())
```


```{r eval=FALSE, include=FALSE}
tracks0702_cv <- tracks0702cl %>% vfold_cv(10)
```

```{r eval=FALSE, include=FALSE}
forest_model <-
  rand_forest() %>%
  set_mode("classification") %>% 
  set_engine("ranger", importance = "impurity")
tracks0702_forest <- 
  workflow() %>% 
  add_recipe(tracks_rec) %>% 
  add_model(forest_model) %>% 
  fit_resamples(
    tracks0702_cv, 
    control = control_resamples(save_pred = TRUE)
  )
```

#### Classifier Precision and Recall ####

*** 

So I did not know if there was a more efficient way to do this but this seemed suitable. Training a random forest classifier to classify the clusters aquired by k-means clustering will show which features are most important when determining what should be in which cluster. 

The precisions seem pretty okay and the importance shows that "mode","instrumentalness" and "energy" are very important when assigning songs to clusters. 

Let's take a look. 

***


```{r}
tracks0702_forest %>% get_pr()

```

#### Important features ####

```{r}
workflow() %>% 
  add_recipe(tracks_rec) %>% 
  add_model(forest_model) %>% 
  fit(tracks0702cl) %>% 
  pluck("fit", "fit", "fit") %>%
  ranger::importance() %>% 
  enframe() %>% 
  mutate(name = fct_reorder(name, value)) %>% 
  ggplot(aes(name, value)) + 
  geom_col() + 
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Importance")
```


### Important features for clusters ###


```{r eval=FALSE, include=FALSE}

p1 <- tracks0702 %>% 
  ggplot(aes(energy,instrumentalness,color=playlist_name)) + geom_point() 

p2 <- tracks0702cl %>% 
  ggplot(aes(energy,instrumentalness,color=cluster)) + geom_point() 

p3 <- tracks0702cl %>% 
  ggplot(aes(mode,fill=playlist_name)) + geom_bar() 

p4 <- tracks0702cl %>% 
  ggplot(aes(mode,fill=cluster)) + geom_bar()
```

#### Energy and instrumentalness ####

```{r}
subplot(p1 %>% ggplotly(), p2 %>% ggplotly(), nrows = 1, margin = 0.04, widths = c(0.5, 0.5))

```

#### Mode ####


```{r}
ggarrange(p3, p4, 
          labels = c("Daily mixes", "K-means clusters"),
          ncol = 2, nrow = 1)

```

*** 

Interesting to see that mode almost completely seperates two groups of three clusters while the actual playlists are distributed equally among the modes. This discriminative power of "mode" is probably due to its binary nature. Possibly I should combine key and mode to get a feature that consists of all 24 possibilities of key_modes. 

I should also train a classifier to daily mixes to actually find out where the daily mixes make their decisions but it is 30 minutes before the deadline currently. 

***

















Estimating listen History from discover weeklies{.storyboard}
================================================





```{r}
tracksMFCC <- tracks %>% 
  count(track.uri,key) %>%
  select(track.uri,key) %>% 
  add_audio_analysis() %>%
  mutate(
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))
```

```{r}
track_feats <- tracks %>% 
  inner_join(tracksMFCC %>% select(-key) %>%  rename(track.id = track.uri))
```

```{r}
feats = c(
  "playlist_name",
  "Day",
  "energy",
  "loudness",
  "speechiness",
  "acousticness", 
  "instrumentalness",
  "liveness",
  "valence",
  "tempo",
  "track.duration_ms",
  "c01", "c02", "c03", "c04", "c05", "c06", "c07" , "c08", "c09", "c10", "c11", "c12",
  "C", "C#|Db", "D", "D#|Eb", "E", "F", "F#|Gb", "G", "G#|Ab", "A", "A#|Bb", "B"
)
W7All <- track_feats %>% 
  filter(Weeknmbr == 6,type=="Daily Mix") %>% 
  bind_rows(track_feats %>% filter(playlist_name == "Weekly7")) %>% 
  select(all_of(feats)) %>% 
  rename(
    "Db" = "C#|Db",
    "Eb" = "D#|Eb",
    "Gb" = "F#|Gb",
    "Ab" = "G#|Ab",
    "Bb" = "A#|Bb"
  ) %>% 
  mutate(
    energy = scale(energy),
    loudness = scale(loudness),
    speechiness = scale(speechiness),
    acousticness = scale(acousticness), 
    instrumentalness = scale(instrumentalness),
    liveness = scale(liveness),
    valence = scale(valence),
    tempo = scale(tempo),
    track.duration_ms = scale(track.duration_ms),
    c01 = scale(c01), c02 = scale(c02), c03 = scale(c03), c04 = scale(c04), c05 = scale(c05),
    c06 = scale(c06), c07 = scale(c07), c08 = scale(c08), c09 = scale(c09), c10 = scale(c10),
    c11 = scale(c11), c12 = scale(c12),
    C = scale(C), Db = scale(Db), D = scale(D), Eb = scale(Eb), E = scale(E), F = scale(F), Gb = scale(Gb), G = scale(G), 
    Ab = scale(Ab), A = scale(A), Bb = scale(Bb), B = scale(B)
  ) 
  

W7 <- W7All %>% 
  group_by(Day,playlist_name) %>% 
  summarise_all(mean) %>% 
  ungroup()
```


### Basic Idea

So now that we have an idea about what features we can extract and analyze using the spotify API, let's return to the research questions: 

(1) Is there a way to predict my discover weekly playlist of the next week based on my daily mixes of the current week.

(2) Is there a way to predict which daily mixes I listened to in the previous week(s) based on my discover weekly playlist. 

Starting off, estimating my next discover weekly based on my daily mixes is going to be difficult. This will require me to compare the daily mixes to every song on spotify to find a fitting match for a discover weekly playlist. This is something spotify does very well and I doubt I will be able to recreate this wonderful algorithm for this project. 

However, determining what daily mixes I listened to the most should be doable. Suppose we look at a discover weekly playlist and the daily mixes of the previous week. We can then write this down as an equation where each daily mix has a weight to determine how much I listened to it: 

$DW =  DM_A^1 * W_1 + DM_B^1 * W_2 +...+ DM_F^7*W_{42}$

Where each playlist is actually a set of features. Now an optimal solution where $ DW $ is estimated exactly likely does not exist. But this can be interpreted as a linear regression problem which we can solve. 

### Feature space

#### feautures on track level

***

Below you can see a table consisting of one week of daily mixes and a discover weekly playlist. Every feature has been z-normalized to ensure that all features are treated as equally important. In this manner every song can be interpreted as a set of features and their values.


```{r}
W7All %>% 
  kbl() %>% 
  kable_styling(fixed_thead = T)

```

#### features on playlist level

***

However, we are interested in the way playlist listen history and not track listen history. For simplicity we can take the mean of each feature for every playlist, resulting in the following feature space:


```{r}
  
W7 %>% 
  kbl() %>%
  #kable_material(c("striped", "hover")) %>% 
  kable_styling(fixed_thead = T)
```



### Least squares fitting

#### Regular Least squares

***

We are interested in the equation: 

$DW =  DM_A^1 * W_1 + DM_B^1 * W_2 +...+ DM_F^7*W_{42}$

which, from the table, reduces to:

$\begin{bmatrix} energy_{DW} \\ loudness_{DW} \\ ... \\ B_{DW} \end{bmatrix} =\begin{bmatrix} energy_{DM_A^1} \\ loudness_{DM_A^1} \\ ... \\ B_{DM_A^1} \end{bmatrix} *W_1 + .... +  \begin{bmatrix} energy_{DM_F^7} \\ loudness_{DM_F^7} \\ ... \\ B_{DM_F^7} \end{bmatrix} * W_{42} $

Now without getting to deep into linear algebra, because there most likely is no optimal solution we need to perform a least squares estimation. For this we need to reformulate this equation as a matrix equation which looks like: 

$\begin{bmatrix} DM_A^1 & DM_B^1 & ... & DM_F^7\end{bmatrix} \begin{bmatrix} W_1 \\ W_2 \\ \vdots \\ W_{42} \end{bmatrix}= \begin{bmatrix} energy_{DW} \\ loudness_{DW} \\ \vdots \\ B_{DW} \end{bmatrix}$

Where each $DM$ is a vector of all the features. 
To perform a least squares estimate we need to multiply each side by the Transpose of our Daily Mix feature matrix and then solve for the vector of weights: 

$\begin{bmatrix} DM_A^1 & DM_B^1 & ... & DM_F^7\end{bmatrix}^T \times \begin{bmatrix} DM_A^1 & DM_B^1 & ... & DM_F^7\end{bmatrix} \times \begin{bmatrix} W_1 \\ W_2 \\ \vdots \\ W_{42} \end{bmatrix} = \begin{bmatrix} DM_A^1 & DM_B^1 & ... & DM_F^7\end{bmatrix}^T \times DW$

This results in the following weights:

```{r}
W7A <- W7[-nrow(W7),] %>% 
  select(-playlist_name,-Day) %>% 
  as.matrix()

W7b <- W7[nrow(W7),] %>% 
  select(-playlist_name,-Day) %>% 
  as.matrix() %>% 
  t()

ATA <- W7A %*% t(W7A)
ATb <- W7A %*% W7b

w <- solve(ATA,ATb,tol = 1e-19)

W7[-nrow(W7),] %>% 
  select(playlist_name) %>% 
  mutate(weight = w) %>% 
  kbl() %>%
  kable_material(c("striped", "hover")) %>% 
  kable_styling(fixed_thead = T)
```

#### Non negative least squares

***

However, coming back to reality from our sidestep into linear algebra. Negative values really do not make sense in this situation. A negative value would suggest that I intentionally ignored several playlists, which could be the case but I doubt spotify can measure this. 

Luckily I found a package online called "nnls" (non negative least squares) which calculates the least squares estimate using only positive values. 

This resulted in the following weights: 

```{r}
nonneg <- nnls(t(W7A),W7b)

W7[-nrow(W7),] %>% 
  select(playlist_name) %>% 
  mutate(weight = nonneg$x) %>% 
  kbl() %>%
  kable_material(c("striped", "hover")) %>% 
  kable_styling(fixed_thead = T)
```



### What does it mean and how well did it do



```{r}
W7b %>% 
  as_tibble() %>% 
  mutate(features = names(W7 %>% select(-Day,-playlist_name)),
         "Least Square fit" = t(W7A) %*% w,
         "LS resids" = V1 - t(W7A) %*% w,
         "Non negative fit" = nonneg$fitted,
         "NNLS resids" = nonneg$residuals) %>% 
  rename(DW = V1)
        
```

***

Unfortunately spotify's recently played function does not let you see past the last 50 recently played songs. This is unfortunate because this makes it harder to determine whether the predictions are correct. But just looking at the weights may allready say something. 



```{r}
nonneg$deviance

sum((t(W7A) %*% w-W7b)**2)
```



Which begs to say: sometimes the optimal parameters do not make sense in reality and it is important to keep mathematics relevant to what you are trying to discover. 








